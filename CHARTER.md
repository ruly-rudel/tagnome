# プロジェクト名

音声圧縮ファイルのタグ管理、ディレクトリ管理ソフトウエアの作成
	
# 目的

大量にあるflacファイルのメタデータ(タグ)は、カテゴリがバラバラだったり、アーティスト名のフォーマットがバラバラだったり、置かれているディレクトリやファイル名が一意でなかったり、ジャケット画像が入ってなかったりしている。それを、スクリプトもしくは設定ファイルにより正規化、再配置し検索性を上げるとともに、将来作るべき音楽再生スマホアプリでの検索容易性につなげる

# 目標

ソフトウェア「TAGnome」の作成

# スコープ

ソフトウェアと利用のためのドキュメント、スクリプト言語もしくは設定言語。
ソフトウェア配布は行わない。

# 要求仕様	

1. 扱う圧縮ファイルはflacのみ。ただし、後々他のフォーマットにも対応したいかもしれないのでハードコーディングは避ける

2.  ある（複数の）ディレクトリ以下のファイルすべてに対して以下の処理を行う

    1. メタデータを読み込む

    2. メタデータを設定に従い修正する。以下、やりたいことの例

        - アーティスト名「ドラマ」は削りアルバムアーティストで代用する

        - キャラ名（声優名）, ...で統一する

        - アルバムアーティストは作品名にする

        - アルバムアーティスト名とジャンルを紐づける

        - 上記すべてに例外を設けられるようにする(firewallのルールみたいに）

    3. ジャケット写真が存在しない場合は、インターネットからジャケット画像らしきものを取得し設定する(大変そうなので後回し)

        1. アルバム名とアーティスト名など、設定に従って検索ワードと検索サイトを変更する

        2. スクレイピングして画像を取り出す

    4. 設定に従いファイルを移動またはコピーする。flac以外のファイルは触らず移動またはコピーする。

3. コールドラン機能

4. アンドゥ機能（難しい場合はやめておく）

5. ファイル名がコンフリクトした際に警告を出す機能
	
	
# 機能リスト	

1. コマンドライン引数をパースしてパラメータとして返す機能

    - SYNOPSYS

        - tagnome [-f script_file] [-e] [-m|-p] [-v] source_dir... dist_dir 

            - -v: verbose。すべてのファイルの移動する/しないを表示する。通常は変更ファイルとディレクトリ単位でのみ表示

            - -e: 移動/コピーを実行する。-eをつけない場合はdry run。

            - -m: ファイルをsource_dirからdist_dirに移動する。-mも-oもつけない場合はすべてのファイルをsource_dirからdist_dirにコピーする(元のディレクトリ・ファイルは変更なし)

            - -p : メタデータに変更がないファイルはsource_dirからdist_dirに移動する。メタデータに変更があるファイル、もしくはその他ファイルはsource_dirからdist_dirにコピーする(元のファイルは変更なし)

            - -f: スクリプトファイル名を設定する。指定しない場合は標準入力からスクリプトを読み込む

2. パラメータを入力とし、パラメータに沿ったコマンドの実行を行う機能

    - -e指定がある場合に実行

3. パラメータを入力とし、実際に変更は行わずログだけ出すドライラン的な機能

    - -e指定がない場合に実行

4. ディレクトリを入力とし、そのディレクトリ以下のファイルのリストを返す機能

5. (標準入力からの)スクリプトをパースし、メタデータ変更ルール（以下ルールと略）のリストを返す機能
    - 難しそうだからDSLっぽくしてコンパイルで埋め込むかも

6. ファイル名からファイルのメタデータを抽出してフルパスと一緒に返す機能
    - 手順は以下とする。STREAM, METADATA_BLOCK_HEADERはbig endian、VORBIS_COMMENTのMETADATA_BLOCK_DATAはlittle endianでパースする。
        1. MAGICを読み、key "MAGIC"としてalistに格納する
        2. 最初のMETADATA_BLOCK_HEADERのBLOCK_TYPEを読み、STREAMINFO(=0)であることを確認する(未実装)
        3. ここでlast-metadata-block flagが立っていたらメタデータ抽出は終了する
        4. METADATA_BLOCK_HEADERのBLOCK_TYPEがVORBIS_COMMENT(=4)になるか、last-metadata-block flagが立つまでMETADATA_BLOCK_HEADERを読みLengthの長さだけMETADATA_BLOCK_DATAを読み飛ばす
        5. METADATA_BLOCK_HEADERのBLOCK_TYPEがVORBIS_COMMENTでなく、かつlast-metadata-blockが立っていた場合はメタデータ抽出は終了する
        6. vender_length、vender_string、user_comment_list_lengthを取得する
        7. user_comment_list_lengthだけ、Lengthとuser_commentを取得し、user_comment文字列を「=」で二分割し、keyとvalueにしてalistに格納する
        8. framing_bitを読み、1がセットされていることを確認する(未実装)
    - すべてのVORBIS_COMMENTのフィールドを抽出する
    - 以下の場合はエラーとし、フルパスとエラー要因を共に表示してコマンドの実行を終了する
        - MAGICが"fLaC"でない場合
        - ファイルポインタがファイルサイズを越した場合(未実装)
        - 最初のメタデータがSTREAMINFOでない場合(未実装)
        - メタデータブロックをパース中に、ファイルポインタがブロックサイズを越した場合(未実装)
        - ブロックタイプがinvalidの場合(未実装)
        - 一つのstringが1kByteを超えた場合(暫定)

7. 一つのルールと一セットのメタデータを入力にして、新しい一セットのメタデータとメタデータに変更あり/なしを出力する機能

8. メタデータの内容に変更がない場合はコピーせず移動する機能

    - -m指定がある場合に実行

9. メタデータの内容に変更がない場合でもコピーする機能（元のファイルは変更しない）
    - -m指定がない場合に実行

10. メタデータの内容を変更してコピーする機能（元のファイルは変更しない）
    - -m指定がない場合に実行

11. メタデータの内容を変更して移動する機能（元のファイルを変更・コピーした後に削除する)
    - -m指定がある場合に実行

12. メタデータの内容を表示する機能
    - 表示の仕方はスクリプトに記述する

13. コピーまたは移動する際に、すでにファイルが存在する場合は警告する機能
    - ドライランで実際にファイル移動・コピーしない場合も同等の警告が出るようにする

# スクリプト言語仕様(まずはDSLでお茶を濁す)

- キャラ名(声優名)フォーマット修正
    - まずartist名だけをダンプするスクリプトを通し、uniqする。
    - 複数アーティスト声優形式だけ目で分類して（号泣）、「、」や「,」でセパレートされているものをsplitしてuniqする。
    - 「キャラ[ *]（CV 声優) -> キャラ(声優)」みたいな感じで置き換えルールをまとめてvimの正規表現で（号泣）作成する。
    - DSLに置き換えリストをそのまま埋め込む。

- アルバムアーティスト修正
    - 先ほどのキャラ名一覧に紐づけて作品名を書く
    - 複数あるトラックのうちで1個でもそのキャラがいれば、アルバム1枚まるごと作品名とする
    - 複数あるトラックで複数の作品のキャラが入っている場合は、列挙させてアルバムアーティストとする


- ドラマ修正
    - アーティスト名「ドラマ」はアルバムアーティストに置き換える
        - 作品名が不明の場合は警告をだしそのままドラマにしておく

- アーティスト名修正
    - 英語のアーティスト名は「At the Drive-in」とかそういう形式に統一しちゃう。先頭のTheのみ最初大文字、そのほかはtheで小文字。inやofなどは小文字、他は先頭大文字ほか小文字
    - 日本語だけど英語文字は半角（）に置き換える
    - ハイフンは文字として触らない

- ジャンル修正
    - アーティスト名とジャンルのリストを作っておく。アーティスト名だけをダンプしてuniqして手作業でジャンル設定(号泣)
    - ジャンル名 -> (アーティスト名のリスト)みたいな対応のほうが作るの楽かも


# 参考
- [flac: Complete high-level binding to libFLAC](https://hackage.haskell.org/package/flac)
- [detailed description of the FLAC format](https://xiph.org/flac/format.html#scope)
- [Ogg Vorbis I format specification: comment field and header specification](https://xiph.org/vorbis/doc/v-comment.html)